{% extends 'base.html' %}

{% block content %}
<div class="exam-marking-container">
    <!-- Header -->
    <div class="marking-header">
        <div class="header-content">
            <div class="header-info">
                <h2 class="exam-title">{{ exam.title }}</h2>
                <p class="driver-info">{{ driver.first_name }} {{ driver.last_name }} | License: {{ driver.license_no|default:"N/A" }}</p>
            </div>
            <div class="header-actions">
                <a href="{% url 'trainingapp:submission_list' exam.id %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Submissions
                </a>
            </div>
        </div>
    </div>

    {% if messages %}
    <div class="messages-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="marking-layout">
        <!-- Left Sidebar: Page Thumbnails -->
        <div class="pdf-thumbnails-sidebar">
            <div class="thumbnails-header">
                <h6 class="mb-0"><i class="fas fa-book"></i> Pages</h6>
            </div>
            <div class="thumbnails-container" id="thumbnails-container">
                <!-- Will be populated by PDF.js -->
            </div>
        </div>

        <!-- Main Content: PDF Viewer -->
        <div class="pdf-viewer-container">
            <div class="pdf-viewer-toolbar">
                <div class="toolbar-group">
                    <button id="pdf-prev-btn" class="toolbar-btn" title="Previous page">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                    <input type="number" id="pdf-page-input" min="1" value="1" class="toolbar-input" title="Go to page">
                    <span class="page-count">of <span id="pdf-total-pages">0</span></span>
                    <button id="pdf-next-btn" class="toolbar-btn" title="Next page">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="toolbar-group">
                    <button id="pdf-zoom-out-btn" class="toolbar-btn" title="Zoom out">
                        <i class="fas fa-minus"></i>
                    </button>
                    <span class="zoom-level" id="pdf-zoom-level">100%</span>
                    <button id="pdf-zoom-in-btn" class="toolbar-btn" title="Zoom in">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="toolbar-group">
                    {% if exam.file %}
                    <a href="{{ exam.file.url }}" download="{{ exam.title }}.pdf" class="toolbar-btn" title="Download PDF">
                        <i class="fas fa-download"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="pdf-canvas-wrapper">
                <canvas id="pdf-canvas" class="pdf-canvas"></canvas>
            </div>
        </div>

        <!-- Right Sidebar: Marking Controls -->
        <div class="marking-controls-sidebar">
            <div class="controls-header">
                <h6 class="mb-0"><i class="fas fa-pen-fancy"></i> Mark Exam</h6>
            </div>

            <form method="post" id="marking-form" class="marking-form">
                {% csrf_token %}

                <!-- Score Input Section -->
                <div class="form-section">
                    <label class="form-label-bold">
                        <i class="fas fa-star"></i> Score
                    </label>
                    <div class="score-input-wrapper">
                        <input 
                            type="number" 
                            name="score" 
                            id="score-input"
                            class="form-control score-input" 
                            placeholder="Enter score"
                            step="0.01"
                            min="0"
                            max="{{ exam.total_marks }}"
                            value="{{ submission.score|default:'' }}"
                        >
                        <span class="score-max">/ {{ exam.total_marks }}</span>
                    </div>
                    <div class="score-help">
                        Total marks available
                    </div>
                </div>

                <!-- Percentage Display -->
                <div class="form-section">
                    <div class="percentage-display">
                        <div class="percentage-circle" id="percentage-circle">
                            <span class="percentage-value" id="percentage-value">â€”</span>%
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="form-section">
                    <label class="form-label-bold">
                        <i class="fas fa-sticky-note"></i> Notes
                    </label>
                    <textarea 
                        name="notes" 
                        id="notes-textarea"
                        class="form-control notes-textarea" 
                        placeholder="Add notes or comments..."
                        rows="6"
                    >{{ submission.notes|default:'' }}</textarea>
                    <div class="notes-help">
                        Optional comments about the exam
                    </div>
                </div>

                <!-- Submission Info -->
                <div class="form-section">
                    <div class="info-card">
                        <div class="info-row">
                            <span class="info-label">Submitted:</span>
                            <span class="info-value">{{ submission.created_at|date:"d M, Y H:i" }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Batch:</span>
                            <span class="info-value">{{ driver.batch.name|default:"N/A" }}</span>
                        </div>
                        {% if submission.graded_at %}
                        <div class="info-row">
                            <span class="info-label">Graded:</span>
                            <span class="info-value">{{ submission.graded_at|date:"d M, Y H:i" }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="form-section">
                    <button type="submit" class="btn btn-primary btn-block btn-lg">
                        <i class="fas fa-save"></i> Save Score & Mark Complete
                    </button>
                    <a href="{% url 'trainingapp:submission_list' exam.id %}" class="btn btn-outline-secondary btn-block">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- PDF.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let pdfDoc = null;
let currentPage = 1;
let zoomLevel = 1;
const canvas = document.getElementById('pdf-canvas');
const ctx = canvas.getContext('2d');
const pdfUrl = '{{ exam.file.url }}';

// Initialize PDF viewer
async function initializePDF() {
    try {
        pdfDoc = await pdfjsLib.getDocument(pdfUrl).promise;
        document.getElementById('pdf-total-pages').textContent = pdfDoc.numPages;
        renderPage(1);
        generateThumbnails();
    } catch (error) {
        console.error('Error loading PDF:', error);
        document.querySelector('.pdf-canvas-wrapper').innerHTML = 
            '<div class="alert alert-danger">Error loading PDF. Please try again.</div>';
    }
}

// Render a specific page
async function renderPage(pageNumber) {
    if (!pdfDoc) return;

    try {
        const page = await pdfDoc.getPage(pageNumber);
        const viewport = page.getViewport({ scale: zoomLevel });

        canvas.width = viewport.width;
        canvas.height = viewport.height;

        const renderContext = {
            canvasContext: ctx,
            viewport: viewport
        };

        await page.render(renderContext).promise;
        currentPage = pageNumber;
        document.getElementById('pdf-page-input').value = pageNumber;

        // Highlight current thumbnail
        document.querySelectorAll('.thumbnail-item').forEach((item, index) => {
            item.classList.toggle('active', index + 1 === pageNumber);
        });
    } catch (error) {
        console.error('Error rendering page:', error);
    }
}

// Generate thumbnails for all pages
async function generateThumbnails() {
    const container = document.getElementById('thumbnails-container');
    container.innerHTML = '';

    for (let i = 1; i <= pdfDoc.numPages; i++) {
        const thumbCanvas = document.createElement('canvas');
        thumbCanvas.className = 'thumbnail-canvas';
        const thumbCtx = thumbCanvas.getContext('2d');

        const page = await pdfDoc.getPage(i);
        const viewport = page.getViewport({ scale: 0.15 });

        thumbCanvas.width = viewport.width;
        thumbCanvas.height = viewport.height;

        await page.render({
            canvasContext: thumbCtx,
            viewport: viewport
        }).promise;

        const thumbItem = document.createElement('div');
        thumbItem.className = 'thumbnail-item';
        thumbItem.innerHTML = `
            <div class="thumbnail-wrapper">
                ${thumbCanvas.outerHTML}
                <span class="thumbnail-label">${i}</span>
            </div>
        `;
        thumbItem.addEventListener('click', () => renderPage(i));

        container.appendChild(thumbItem);
    }

    if (pdfDoc.numPages > 0) {
        document.querySelector('.thumbnail-item').classList.add('active');
    }
}

// Navigation handlers
document.getElementById('pdf-prev-btn').addEventListener('click', () => {
    if (currentPage > 1) renderPage(currentPage - 1);
});

document.getElementById('pdf-next-btn').addEventListener('click', () => {
    if (pdfDoc && currentPage < pdfDoc.numPages) renderPage(currentPage + 1);
});

document.getElementById('pdf-page-input').addEventListener('change', (e) => {
    const page = Math.max(1, Math.min(parseInt(e.target.value) || 1, pdfDoc.numPages));
    renderPage(page);
});

// Zoom handlers
document.getElementById('pdf-zoom-out-btn').addEventListener('click', () => {
    zoomLevel = Math.max(0.5, zoomLevel - 0.1);
    document.getElementById('pdf-zoom-level').textContent = Math.round(zoomLevel * 100) + '%';
    renderPage(currentPage);
});

document.getElementById('pdf-zoom-in-btn').addEventListener('click', () => {
    zoomLevel = Math.min(3, zoomLevel + 0.1);
    document.getElementById('pdf-zoom-level').textContent = Math.round(zoomLevel * 100) + '%';
    renderPage(currentPage);
});

// Score calculation and display
const scoreInput = document.getElementById('score-input');
const totalMarks = {{ exam.total_marks }};

scoreInput.addEventListener('input', () => {
    const score = parseFloat(scoreInput.value);
    const percentageElement = document.getElementById('percentage-value');
    const percentageCircle = document.getElementById('percentage-circle');

    if (isNaN(score) || score === '') {
        percentageElement.textContent = 'â€”';
        percentageCircle.style.background = 'linear-gradient(135deg, #e0e0e0 0%, #f0f0f0 100%)';
    } else {
        const percentage = Math.round((score / totalMarks) * 100);
        percentageElement.textContent = percentage;

        // Color coding: red to yellow to green
        let color;
        if (percentage < 50) {
            color = `linear-gradient(135deg, #dc3545 0%, #ff6b6b 100%)`;
        } else if (percentage < 75) {
            color = `linear-gradient(135deg, #ffc107 0%, #ffb300 100%)`;
        } else {
            color = `linear-gradient(135deg, #28a745 0%, #20c997 100%)`;
        }
        percentageCircle.style.background = color;
    }
});

// Initialize
if (pdfUrl && pdfUrl.includes('/media/')) {
    initializePDF();
} else {
    document.querySelector('.pdf-canvas-wrapper').innerHTML = 
        '<div class="alert alert-info">No exam PDF available for viewing.</div>';
}
</script>

<style>
.exam-marking-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    background-color: #f5f5f5;
}

.marking-header {
    background: white;
    border-bottom: 1px solid #e0e0e0;
    padding: 1rem 1.5rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-info h2 {
    margin: 0;
    font-size: 1.5rem;
    color: #333;
}

.driver-info {
    margin: 0.25rem 0 0 0;
    font-size: 0.9rem;
    color: #666;
}

.messages-container {
    padding: 1rem 1.5rem 0;
}

.messages-container .alert {
    margin-bottom: 1rem;
}

.marking-layout {
    display: flex;
    flex: 1;
    overflow: hidden;
    gap: 1px;
    background-color: #ddd;
}

/* Left Sidebar - Thumbnails */
.pdf-thumbnails-sidebar {
    width: 140px;
    background: white;
    border-right: 1px solid #e0e0e0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.thumbnails-header {
    padding: 1rem 0.75rem;
    border-bottom: 1px solid #e0e0e0;
    background: #f8f9fa;
}

.thumbnails-header h6 {
    font-size: 0.85rem;
    font-weight: 600;
    color: #333;
}

.thumbnails-container {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem;
}

.thumbnail-item {
    margin-bottom: 0.5rem;
    cursor: pointer;
    border-radius: 4px;
    overflow: hidden;
    border: 2px solid transparent;
    transition: all 0.2s ease;
}

.thumbnail-item:hover {
    border-color: #667eea;
    background-color: #f0f0f0;
}

.thumbnail-item.active {
    border-color: #667eea;
    box-shadow: 0 0 8px rgba(102, 126, 234, 0.3);
}

.thumbnail-wrapper {
    position: relative;
    background: #f5f5f5;
    border-radius: 3px;
    overflow: hidden;
}

.thumbnail-canvas {
    display: block;
    width: 100%;
    height: auto;
}

.thumbnail-label {
    position: absolute;
    bottom: 4px;
    right: 4px;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 2px;
    font-weight: bold;
}

/* Center - PDF Viewer */
.pdf-viewer-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: white;
    overflow: hidden;
}

.pdf-viewer-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    gap: 1rem;
}

.toolbar-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.toolbar-btn {
    background: white;
    border: 1px solid #ddd;
    padding: 0.5rem 0.75rem;
    border-radius: 4px;
    cursor: pointer;
    color: #333;
    font-size: 0.9rem;
    transition: all 0.2s ease;
}

.toolbar-btn:hover {
    background: #e8e9f3;
    border-color: #667eea;
    color: #667eea;
}

.toolbar-input {
    width: 50px;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    text-align: center;
    font-size: 0.9rem;
}

.page-count {
    font-size: 0.9rem;
    color: #666;
    margin: 0 0.5rem;
    white-space: nowrap;
}

.zoom-level {
    font-size: 0.9rem;
    color: #666;
    min-width: 45px;
    text-align: center;
}

.pdf-canvas-wrapper {
    flex: 1;
    overflow: auto;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    background: #e0e0e0;
    padding: 2rem 1rem;
}

.pdf-canvas {
    max-width: 100%;
    height: auto;
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

/* Right Sidebar - Controls */
.marking-controls-sidebar {
    width: 320px;
    background: white;
    border-left: 1px solid #e0e0e0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.controls-header {
    padding: 1rem;
    border-bottom: 1px solid #e0e0e0;
    background: #f8f9fa;
}

.controls-header h6 {
    font-size: 0.95rem;
    font-weight: 600;
    color: #333;
}

.marking-form {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
}

.form-section {
    margin-bottom: 1.5rem;
}

.form-section:last-child {
    margin-top: auto;
    margin-bottom: 0;
}

.form-label-bold {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
}

.score-input-wrapper {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.score-input {
    flex: 1;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 1.1rem;
    font-weight: 600;
}

.score-input:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.score-max {
    font-size: 0.9rem;
    color: #666;
    font-weight: 500;
}

.score-help {
    font-size: 0.8rem;
    color: #999;
    margin-top: 0.25rem;
}

.percentage-display {
    display: flex;
    justify-content: center;
    padding: 1rem 0;
}

.percentage-circle {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, #e0e0e0 0%, #f0f0f0 100%);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: background 0.3s ease;
}

.percentage-value {
    font-size: 2rem;
    font-weight: bold;
    color: white;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.notes-textarea {
    resize: vertical;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 0.75rem;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    font-size: 0.9rem;
}

.notes-textarea:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.notes-help {
    font-size: 0.8rem;
    color: #999;
    margin-top: 0.25rem;
}

.info-card {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 0.75rem;
}

.info-row {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    font-size: 0.85rem;
    border-bottom: 1px solid #e0e0e0;
}

.info-row:last-child {
    border-bottom: none;
}

.info-label {
    font-weight: 600;
    color: #666;
}

.info-value {
    color: #333;
    text-align: right;
}

.btn-block {
    width: 100%;
}

.btn-lg {
    padding: 0.75rem;
    font-size: 1rem;
}

/* Scrollbar styling */
.thumbnails-container::-webkit-scrollbar,
.marking-form::-webkit-scrollbar,
.pdf-canvas-wrapper::-webkit-scrollbar {
    width: 6px;
}

.thumbnails-container::-webkit-scrollbar-track,
.marking-form::-webkit-scrollbar-track,
.pdf-canvas-wrapper::-webkit-scrollbar-track {
    background: #f0f0f0;
}

.thumbnails-container::-webkit-scrollbar-thumb,
.marking-form::-webkit-scrollbar-thumb,
.pdf-canvas-wrapper::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 3px;
}

.thumbnails-container::-webkit-scrollbar-thumb:hover,
.marking-form::-webkit-scrollbar-thumb:hover,
.pdf-canvas-wrapper::-webkit-scrollbar-thumb:hover {
    background: #999;
}

/* Responsive Design */
@media (max-width: 1400px) {
    .pdf-thumbnails-sidebar {
        width: 100px;
    }

    .marking-controls-sidebar {
        width: 280px;
    }
}

@media (max-width: 1200px) {
    .marking-layout {
        flex-direction: column;
    }

    .pdf-thumbnails-sidebar,
    .marking-controls-sidebar {
        width: 100%;
        max-height: 30vh;
        border-right: none;
        border-left: none;
    }

    .pdf-thumbnails-sidebar {
        border-bottom: 1px solid #e0e0e0;
    }

    .thumbnails-container {
        display: flex;
        gap: 0.5rem;
        overflow-x: auto;
        overflow-y: hidden;
        padding: 0.75rem 0.5rem;
    }

    .thumbnail-item {
        flex: 0 0 80px;
    }

    .marking-form {
        flex-direction: row;
        flex-wrap: wrap;
        align-items: flex-start;
    }

    .form-section {
        flex: 0 0 calc(50% - 0.75rem);
        margin-right: 1rem;
    }

    .form-section:nth-child(odd) {
        margin-right: 0.5rem;
    }
}

@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        gap: 1rem;
    }

    .header-actions {
        width: 100%;
    }

    .header-actions a {
        width: 100%;
    }

    .marking-layout {
        gap: 0;
    }

    .pdf-viewer-toolbar {
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .toolbar-group {
        flex: 0 1 auto;
    }
}
</style>
{% endblock %}
