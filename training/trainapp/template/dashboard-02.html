{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="page-title">
    <div class="row">
      <div class="col-6"><h4>Training Dashboard</h4></div>
      <div class="col-6">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{% url 'trainingapp:dashboard' %}"><svg class="stroke-icon"><use href="{% static 'assets/svg/icon-sprite.svg' %}#stroke-home"></use></svg></a></li>
          <li class="breadcrumb-item active">Overview</li>
        </ol>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3">
    <div class="col-xxl-3 col-sm-6">
      <div class="card">
        <div class="card-body">
          <div class="product-cost d-flex align-items-center justify-content-between">
            <div class="product-icon bg-primary-light"><svg><use href="{% static 'assets/svg/icon-sprite.svg' %}#people"></use></svg></div>
            <div class="text-end"><span class="f-w-500 f-14 mb-0">Drivers</span><h2 class="f-w-600 mb-0">{{ drivers_count }}</h2><div class="text-muted">{{ new_drivers_this_month }} new this month</div></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xxl-3 col-sm-6">
      <div class="card">
        <div class="card-body">
          <div class="product-cost d-flex align-items-center justify-content-between">
            <div class="product-icon bg-warning-light"><svg><use href="{% static 'assets/svg/icon-sprite.svg' %}#task-square"></use></svg></div>
            <div class="text-end"><span class="f-w-500 f-14 mb-0">Batches</span><h2 class="f-w-600 mb-0">{{ batch_count }}</h2><div class="text-muted">Upcoming: {{ upcoming_total }}</div></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xxl-3 col-sm-6">
      <div class="card">
        <div class="card-body">
          <div class="product-cost d-flex align-items-center justify-content-between">
            <div class="product-icon bg-light"><svg><use href="{% static 'assets/svg/icon-sprite.svg' %}#stroke-file"></use></svg></div>
            <div class="text-end"><span class="f-w-500 f-14 mb-0">Exams</span><h2 class="f-w-600 mb-0">{{ exams_count }}</h2><div class="text-muted">Updated: {{ now_time|date:"Y-m-d H:i" }}</div></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xxl-3 col-sm-6">
      <div class="card">
        <div class="card-body">
          <div class="product-cost d-flex align-items-center justify-content-between">
            <div class="product-icon bg-success"><svg><use href="{% static 'assets/svg/icon-sprite.svg' %}#activity"></use></svg></div>
            <div class="text-end"><span class="f-w-500 f-14 mb-0">Scored</span><h2 class="f-w-600 mb-0">{{ scored_count }}</h2><div class="text-muted">All-time</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="row g-3 mt-1">
    <div class="col-xxl-6 col-md-6">
      <div class="card h-100">
        <div class="card-header"><h5 class="mb-0">Exam Status</h5></div>
        <div class="card-body">
          <div style="position:relative;height:300px"><canvas id="statusChart"></canvas></div>
          <div class="row text-center mt-3">
            <div class="col-4"><div class="legend-item"><div class="legend-color" style="background:#60a5fa"></div><small>Assigned</small><div class="fw-bold">{{ status_counts.assigned }}</div></div></div>
            <div class="col-4"><div class="legend-item"><div class="legend-color" style="background:#f59e0b"></div><small>Completed</small><div class="fw-bold">{{ status_counts.completed }}</div></div></div>
            <div class="col-4"><div class="legend-item"><div class="legend-color" style="background:#22c55e"></div><small>Scored</small><div class="fw-bold">{{ status_counts.scored }}</div></div></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xxl-6 col-md-6">
      <div class="card h-100">
        <div class="card-header"><h5 class="mb-0">Exams by Batch (Top 5)</h5></div>
        <div class="card-body">
          <div style="position:relative;height:300px"><canvas id="batchChart"></canvas></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions & Recent Exams -->
  <div class="row g-3 mt-1">
    <div class="col-xxl-6">
      <div class="card h-100">
        <div class="card-header card-no-border pb-0"><h4>Quick Actions</h4></div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-sm-6"><a class="btn btn-primary w-100" href="{% url 'trainingapp:driver_create' %}">Add Driver</a></div>
            <div class="col-sm-6"><a class="btn btn-outline-primary w-100" href="{% url 'trainingapp:batch_create' %}">Create Batch</a></div>
            <div class="col-sm-6"><a class="btn btn-outline-secondary w-100" href="{% url 'trainingapp:exam_upload' %}">Upload Exam</a></div>
            <div class="col-sm-6"><a class="btn btn-outline-info w-100" href="{% url 'trainingapp:exam_list' %}">View Exams</a></div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-xxl-6">
      <div class="card h-100">
        <div class="card-header card-no-border pb-0"><h4>Recent Exams</h4></div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="bg-light">
                <tr><th>Title</th><th>Batch</th><th>Marks</th><th>Uploaded</th></tr>
              </thead>
              <tbody>
                {% for e in recent_exams %}
                  <tr>
                    <td>{{ e.title }}</td>
                    <td>{{ e.batch|default:"-" }}</td>
                    <td>{{ e.total_marks }}</td>
                    <td>{{ e.created_at|date:"Y-m-d H:i" }}</td>
                  </tr>
                {% empty %}
                  <tr><td colspan="4" class="text-center">No exams yet.</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  document.addEventListener('DOMContentLoaded', function(){
    try{
      var ctx1 = document.getElementById('statusChart');
      if(ctx1){
        new Chart(ctx1.getContext('2d'), {
          type: 'doughnut',
          data: {
            labels: ['Assigned','Completed','Scored'],
            datasets: [{
              data: [{{ status_counts.assigned }}, {{ status_counts.completed }}, {{ status_counts.scored }}],
              backgroundColor: ['#60a5fa','#f59e0b','#22c55e'],
              borderColor: '#ffffff',
              borderWidth: 2
            }]
          },
          options: {responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, cutout:'55%'}
        });
      }
    }catch(e){ console.error('status chart', e); }

    try{
      var ctx2 = document.getElementById('batchChart');
      if(ctx2){
        new Chart(ctx2.getContext('2d'), {
          type: 'bar',
          data: {
            labels: {{ batch_labels|safe }},
            datasets: [{
              label: 'Exams',
              data: {{ batch_exam_counts|safe }},
              backgroundColor: 'rgba(78,121,167,0.8)',
              borderColor: 'rgb(78,121,167)',
              borderWidth: 1,
              borderRadius: 6,
              barPercentage: 0.6
            }]
          },
          options: {responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
        });
      }
    }catch(e){ console.error('batch chart', e); }
  });
})();
</script>
{% endblock %}
