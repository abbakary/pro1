{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
  .dashboard-wrapper {
    background: #f5f6fb;
    min-height: 100vh;
  }
  
  .page-title {
    margin-bottom: 2rem;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }
  
  .stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    border-left: 4px solid #667eea;
  }
  
  .stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.12);
  }
  
  .stat-card.primary {
    border-left-color: #667eea;
  }
  
  .stat-card.warning {
    border-left-color: #f59e0b;
  }
  
  .stat-card.success {
    border-left-color: #22c55e;
  }
  
  .stat-card.danger {
    border-left-color: #ef4444;
  }
  
  .stat-card.secondary {
    border-left-color: #8b5cf6;
  }
  
  .stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }
  
  .stat-icon.primary-light {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
  }
  
  .stat-icon.warning-light {
    background: rgba(245, 158, 11, 0.1);
    color: #f59e0b;
  }
  
  .stat-icon.success-light {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
  }
  
  .stat-icon.danger-light {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
  }
  
  .stat-icon.secondary-light {
    background: rgba(139, 92, 246, 0.1);
    color: #8b5cf6;
  }
  
  .stat-label {
    font-size: 0.875rem;
    color: #6b7280;
    font-weight: 500;
    margin-bottom: 0.5rem;
  }
  
  .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #1f2937;
    margin-bottom: 0.5rem;
  }
  
  .stat-change {
    font-size: 0.85rem;
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }
  
  .stat-change.positive {
    color: #22c55e;
  }
  
  .stat-change.negative {
    color: #ef4444;
  }
  
  .card-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }
  
  @media (max-width: 1024px) {
    .card-section {
      grid-template-columns: 1fr;
    }
  }
  
  .chart-container {
    position: relative;
    height: 320px;
    margin-bottom: 1.5rem;
  }
  
  .chart-legend {
    display: flex;
    justify-content: center;
    gap: 2rem;
    flex-wrap: wrap;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e5e7eb;
  }
  
  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
  }
  
  .legend-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
  }
  
  .card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: none;
    overflow: hidden;
  }
  
  .card-header {
    background: #f9fafb;
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .card-header h5 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
    color: #1f2937;
  }
  
  .card-header-link {
    color: #667eea;
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    transition: color 0.2s;
  }
  
  .card-header-link:hover {
    color: #5568d3;
  }
  
  .card-body {
    padding: 1.5rem;
  }
  
  .table-responsive {
    overflow-x: auto;
  }
  
  .table {
    margin-bottom: 0;
    font-size: 0.875rem;
  }
  
  .table thead th {
    background: #f3f4f6;
    color: #374151;
    font-weight: 600;
    border: none;
    padding: 1rem;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
  }
  
  .table tbody td {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    vertical-align: middle;
  }
  
  .table tbody tr:hover {
    background: #f9fafb;
  }
  
  .table tbody tr:last-child td {
    border-bottom: none;
  }
  
  .badge {
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .badge-assigned {
    background: rgba(96, 165, 250, 0.1);
    color: #2563eb;
  }
  
  .badge-completed {
    background: rgba(251, 146, 60, 0.1);
    color: #ea580c;
  }
  
  .badge-scored {
    background: rgba(34, 197, 94, 0.1);
    color: #059669;
  }
  
  .quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
  }
  
  .action-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    border-radius: 8px;
    border: 2px solid #e5e7eb;
    background: white;
    cursor: pointer;
    text-decoration: none;
    color: #374151;
    transition: all 0.2s;
    gap: 0.5rem;
  }
  
  .action-btn:hover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
    color: #667eea;
  }
  
  .action-btn i {
    font-size: 1.5rem;
  }
  
  .action-btn span {
    font-size: 0.75rem;
    font-weight: 600;
    text-align: center;
  }
  
  .section-divider {
    height: 1px;
    background: #e5e7eb;
    margin: 2rem 0;
  }
  
  .text-muted-sm {
    font-size: 0.8rem;
    color: #9ca3af;
  }
  
  .driver-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  .driver-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
    flex-shrink: 0;
  }
  
  .driver-name {
    font-weight: 500;
    color: #1f2937;
  }
  
  .empty-state {
    text-align: center;
    padding: 2rem;
    color: #9ca3af;
  }
  
  .empty-state-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    opacity: 0.5;
  }
  
  .row-full {
    display: grid;
    grid-template-columns: 1fr;
  }
  
  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    
    .card-section {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    
    .stat-value {
      font-size: 1.5rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
  <div class="container-fluid">
    <!-- Page Title -->
    <div class="page-title">
      <div class="row align-items-center mb-4">
        <div class="col-auto">
          <h3 class="f-w-700" style="margin: 0; font-size: 1.75rem;">Dashboard Overview</h3>
          <p class="text-muted mb-0">Welcome back! Here's what's happening with your training system today.</p>
        </div>
      </div>
    </div>

    <!-- Key Statistics Cards -->
    <div class="stats-grid">
      <!-- Total Drivers -->
      <div class="stat-card primary">
        <div class="stat-icon primary-light"><i class="fa fa-users"></i></div>
        <div class="stat-label">Total Drivers</div>
        <div class="stat-value">{{ drivers_count }}</div>
        <div class="stat-change positive">
          <i class="fa fa-arrow-up"></i>
          <span>{{ new_drivers_this_week }} added this week</span>
        </div>
      </div>

      <!-- Total Batches -->
      <div class="stat-card warning">
        <div class="stat-icon warning-light"><i class="fa fa-layers"></i></div>
        <div class="stat-label">Total Batches</div>
        <div class="stat-value">{{ batch_count }}</div>
        <div class="stat-change">
          <i class="fa fa-calendar"></i>
          <span>{{ upcoming_total }} upcoming sessions</span>
        </div>
      </div>

      <!-- Total Exams -->
      <div class="stat-card success">
        <div class="stat-icon success-light"><i class="fa fa-file-text"></i></div>
        <div class="stat-label">Total Exams</div>
        <div class="stat-value">{{ exams_count }}</div>
        <div class="stat-change">
          <i class="fa fa-check"></i>
          <span>{{ scored_count }} scored</span>
        </div>
      </div>

      <!-- Total Submissions -->
      <div class="stat-card secondary">
        <div class="stat-icon secondary-light"><i class="fa fa-inbox"></i></div>
        <div class="stat-label">Total Submissions</div>
        <div class="stat-value">{{ submissions_total }}</div>
        <div class="stat-change">
          <i class="fa fa-hourglass-half"></i>
          <span>{{ pending_score }} pending scoring</span>
        </div>
      </div>

      <!-- Scored Submissions -->
      <div class="stat-card primary">
        <div class="stat-icon primary-light"><i class="fa fa-check-circle"></i></div>
        <div class="stat-label">Submissions Scored</div>
        <div class="stat-value">{{ scored_count }}</div>
        <div class="stat-change positive">
          <i class="fa fa-arrow-up"></i>
          <span>{{ new_submissions_this_week }} this week</span>
        </div>
      </div>

      <!-- Pending Scoring -->
      <div class="stat-card danger">
        <div class="stat-icon danger-light"><i class="fa fa-clock-o"></i></div>
        <div class="stat-label">Pending Scoring</div>
        <div class="stat-value">{{ pending_score }}</div>
        <div class="stat-change negative">
          <i class="fa fa-arrow-right"></i>
          <span>Need attention</span>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="card-section">
      <!-- Exam Status Distribution -->
      <div class="card">
        <div class="card-header">
          <h5>Exam Distribution Status</h5>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="statusChart"></canvas>
          </div>
          <div class="chart-legend">
            <div class="legend-item">
              <div class="legend-dot" style="background: #60a5fa;"></div>
              <span>Assigned: <strong>{{ status_counts.assigned }}</strong></span>
            </div>
            <div class="legend-item">
              <div class="legend-dot" style="background: #f59e0b;"></div>
              <span>Completed: <strong>{{ status_counts.completed }}</strong></span>
            </div>
            <div class="legend-item">
              <div class="legend-dot" style="background: #22c55e;"></div>
              <span>Scored: <strong>{{ status_counts.scored }}</strong></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Exams by Batch -->
      <div class="card">
        <div class="card-header">
          <h5>Exams by Batch</h5>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="batchChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Submissions & Quick Actions Section -->
    <div class="card-section">
      <!-- Recent Submissions -->
      <div class="card">
        <div class="card-header">
          <h5>Recent Submissions</h5>
          <a href="{% url 'trainapp:exam_list' %}" class="card-header-link">View All</a>
        </div>
        <div class="card-body p-0">
          {% if recent_submissions %}
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Driver</th>
                    <th>Exam</th>
                    <th>Status</th>
                    <th>Score</th>
                  </tr>
                </thead>
                <tbody>
                  {% for sub in recent_submissions %}
                    <tr>
                      <td>
                        <div class="driver-info">
                          <div class="driver-avatar">{{ sub.driver.first_name|first|upper }}</div>
                          <div>
                            <div class="driver-name">{{ sub.driver.first_name }} {{ sub.driver.last_name }}</div>
                            <div class="text-muted-sm">{{ sub.driver.license_no }}</div>
                          </div>
                        </div>
                      </td>
                      <td>
                        <div class="driver-name">{{ sub.exam.title|truncatewords:3 }}</div>
                        <div class="text-muted-sm">{{ sub.exam.batch }}</div>
                      </td>
                      <td>
                        {% if sub.score is not None %}
                          <span class="badge badge-scored">Scored</span>
                        {% else %}
                          <span class="badge badge-completed">Completed</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if sub.score is not None %}
                          <strong>{{ sub.score }}/{{ sub.exam.total_marks }}</strong>
                        {% else %}
                          <span class="text-muted">—</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="empty-state">
              <div class="empty-state-icon"><i class="fa fa-inbox"></i></div>
              <p>No submissions yet</p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Quick Actions & Recent Exams -->
      <div>
        <!-- Quick Actions -->
        <div class="card mb-4">
          <div class="card-header">
            <h5>Quick Actions</h5>
          </div>
          <div class="card-body">
            <div class="quick-actions">
              <a href="{% url 'trainapp:driver_create' %}" class="action-btn">
                <i class="fa fa-user-plus"></i>
                <span>Add Driver</span>
              </a>
              <a href="{% url 'trainapp:batch_create' %}" class="action-btn">
                <i class="fa fa-layer-group"></i>
                <span>Create Batch</span>
              </a>
              <a href="{% url 'trainapp:exam_upload' %}" class="action-btn">
                <i class="fa fa-upload"></i>
                <span>Upload Exam</span>
              </a>
              <a href="{% url 'trainapp:score_submissions' %}" class="action-btn">
                <i class="fa fa-pencil"></i>
                <span>Score Exams</span>
              </a>
            </div>
          </div>
        </div>

        <!-- Recent Exams -->
        <div class="card">
          <div class="card-header">
            <h5>Recent Exams</h5>
            <a href="{% url 'trainapp:exam_list' %}" class="card-header-link">View All</a>
          </div>
          <div class="card-body p-0">
            {% if recent_exams %}
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Title</th>
                      <th>Batch</th>
                      <th>Total Marks</th>
                      <th>Date</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for exam in recent_exams %}
                      <tr>
                        <td>
                          <a href="{% url 'trainapp:exam_view' exam.id %}" style="color: #667eea; text-decoration: none; font-weight: 500;">
                            {{ exam.title|truncatewords:4 }}
                          </a>
                        </td>
                        <td>
                          <span class="text-muted-sm">{{ exam.batch|default:"—" }}</span>
                        </td>
                        <td>
                          <strong>{{ exam.total_marks }}</strong>
                        </td>
                        <td>
                          <span class="text-muted-sm">{{ exam.created_at|date:"M d, y" }}</span>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="empty-state">
                <div class="empty-state-icon"><i class="fa fa-file-text-o"></i></div>
                <p>No exams uploaded yet</p>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom Section: Pending Submissions & Top Performers -->
    <div class="card-section">
      <!-- Pending Score Reviews -->
      <div class="card">
        <div class="card-header">
          <h5>Pending Score Reviews</h5>
          <a href="{% url 'trainapp:score_submissions' %}" class="card-header-link">Score Now</a>
        </div>
        <div class="card-body p-0">
          {% if pending_submissions %}
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Driver</th>
                    <th>Exam</th>
                    <th>Submitted</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for sub in pending_submissions %}
                    <tr>
                      <td>
                        <div class="driver-info">
                          <div class="driver-avatar">{{ sub.driver.first_name|first|upper }}</div>
                          <div>
                            <div class="driver-name">{{ sub.driver.first_name }} {{ sub.driver.last_name }}</div>
                          </div>
                        </div>
                      </td>
                      <td>
                        {{ sub.exam.title|truncatewords:3 }}
                      </td>
                      <td>
                        <span class="text-muted-sm">{{ sub.created_at|date:"M d, H:i" }}</span>
                      </td>
                      <td>
                        <a href="{% url 'trainapp:score_submission' sub.exam.id sub.driver.id %}" class="btn btn-sm btn-outline-primary" style="font-size: 0.75rem;">Score</a>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="empty-state">
              <div class="empty-state-icon"><i class="fa fa-check-circle"></i></div>
              <p>All submissions have been scored!</p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Top Performing Drivers -->
      <div class="card">
        <div class="card-header">
          <h5>Top Performing Drivers</h5>
          <a href="{% url 'trainapp:driver_list' %}" class="card-header-link">View All</a>
        </div>
        <div class="card-body p-0">
          {% if top_performing_drivers %}
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>Driver</th>
                    <th>Avg Score</th>
                    <th>Exams</th>
                  </tr>
                </thead>
                <tbody>
                  {% for driver in top_performing_drivers %}
                    <tr>
                      <td>
                        <strong style="color: #667eea; font-size: 1.1rem;">
                          {% if forloop.counter == 1 %}
                            🥇
                          {% elif forloop.counter == 2 %}
                            🥈
                          {% elif forloop.counter == 3 %}
                            🥉
                          {% else %}
                            #{{ forloop.counter }}
                          {% endif %}
                        </strong>
                      </td>
                      <td>
                        <div class="driver-info">
                          <div class="driver-avatar">{{ driver.first_name|first|upper }}</div>
                          <div>
                            <div class="driver-name">{{ driver.first_name }} {{ driver.last_name }}</div>
                            <div class="text-muted-sm">{{ driver.license_no }}</div>
                          </div>
                        </div>
                      </td>
                      <td>
                        <strong style="color: #22c55e;">{{ driver.avg_score|floatformat:2 }}</strong>
                      </td>
                      <td>
                        <span class="text-muted-sm">{{ driver.score_count }} exams</span>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="empty-state">
              <div class="empty-state-icon"><i class="fa fa-star-o"></i></div>
              <p>No driver performance data yet</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
(function(){
  document.addEventListener('DOMContentLoaded', function(){
    try {
      var ctx1 = document.getElementById('statusChart');
      if(ctx1) {
        new Chart(ctx1.getContext('2d'), {
          type: 'doughnut',
          data: {
            labels: ['Assigned', 'Completed', 'Scored'],
            datasets: [{
              data: [{{ status_counts.assigned }}, {{ status_counts.completed }}, {{ status_counts.scored }}],
              backgroundColor: ['#60a5fa', '#f59e0b', '#22c55e'],
              borderColor: '#ffffff',
              borderWidth: 3,
              hoverBorderColor: '#f5f6fb',
              hoverBorderWidth: 3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            cutout: '60%'
          }
        });
      }
    } catch(e) { console.error('status chart error:', e); }

    try {
      var ctx2 = document.getElementById('batchChart');
      if(ctx2) {
        new Chart(ctx2.getContext('2d'), {
          type: 'bar',
          data: {
            labels: {{ batch_labels|safe }},
            datasets: [{
              label: 'Exams Count',
              data: {{ batch_exam_counts|safe }},
              backgroundColor: 'rgba(102, 126, 234, 0.8)',
              borderColor: 'rgb(102, 126, 234)',
              borderWidth: 1,
              borderRadius: 8,
              barPercentage: 0.6,
              categoryPercentage: 0.7
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { stepSize: 1 },
                grid: { color: 'rgba(0, 0, 0, 0.05)' }
              },
              x: {
                grid: { display: false }
              }
            }
          }
        });
      }
    } catch(e) { console.error('batch chart error:', e); }
  });
})();
</script>
{% endblock %}
